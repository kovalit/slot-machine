var config={symbolWidth:216,symbolHeight:144,slotCount:3,lineCount:3,typeCount:4,centerLine:2,availableSymbols:["A","B","C","D","E"],speed:12,winAnimationCount:5,stopDelay:1e3,stopSlotDelay:1e3,winAnimationDelay:200},game={countSymbolInSlot:null,width:null,height:null,slotHeight:null,winIterator:0,isPlay:!1,field:{},stopedSlots:{},centerSymbols:null,init:function(){this.winIterator=0,this.field={},this.centerSymbols=[],this.fillField(),this.initStopedSlots(),main.context.clearRect(0,0,game.width,game.height)},initStopedSlots:function(){for(var i=1;i<=config.slotCount;i++)this.stopedSlots[i]={isFinishTime:!1,isFinishCalc:!1,isFinishDraw:!1}},stop:function(){for(var i=1;i<=config.slotCount;i++){var t=game.stopedSlots[i].isFinishTime;if(!t){game.stopedSlots[i].isFinishTime=!0;break}}var o=game.stopedSlots[config.slotCount].isFinishTime;o||setTimeout(game.stop,config.stopSlotDelay)},fillField:function(){for(var i={},t=1;t<=config.slotCount;t++){i[t]=[];for(var o=1;o<=config.typeCount;o++){var e=this.shuffle(config.availableSymbols);i[t]=i[t].concat(e)}}for(var t=1;t<=config.slotCount;t++){this.field[t]={};for(var n=config.symbolWidth*(t-1),o=1;o<=game.countSymbolInSlot;o++){var a=config.symbolHeight*(o-1);o>config.lineCount&&(a-=this.slotHeight),this.field[t][o]={x:n,y:a,type:i[t][o-1]}}}},draw:function(){game.calc();for(var i=0,t=1;t<config.slotCount;t++)game.stopedSlots[t].isFinishDraw&&(i+=config.symbolWidth);main.context.clearRect(i,0,game.width-i,game.height);for(var t=1;t<=config.slotCount;t++)if(!game.stopedSlots[t].isFinishDraw){for(var o=1;o<=game.countSymbolInSlot;o++){var e=game.field[t][o].x,n=game.field[t][o].y,a=game.field[t][o].type,s=n+config.symbolHeight>0;s&&main.context.drawImage(main.symbols[a].img,0,0,config.symbolWidth,config.symbolHeight,e,n,config.symbolWidth,config.symbolHeight)}game.stopedSlots[t].isFinishCalc&&(game.stopedSlots[t].isFinishDraw=!0)}var m=game.stopedSlots[config.slotCount].isFinishDraw;if(m){game.isPlay=!1;var l=game.checkWin();l&&requestAnimationFrame(game.winAnimation)}else requestAnimationFrame(game.draw)},calc:function(){for(var i=1;i<=config.slotCount;i++){var t=config.speed;if(!game.stopedSlots[i].isFinishCalc){if(game.stopedSlots[i].isFinishTime){var o=game.calcBalance(i);t=o.offset,game.stopedSlots[i].isFinishCalc=o.isLastCalc}for(var e=1;e<=game.countSymbolInSlot;e++){var n=game.field[i][e].y;n+=t,n>game.height&&(n=-game.slotHeight+n),game.field[i][e].y=n}}}},calcBalance:function(i){for(var t={offset:config.speed,isLastCalc:!1},o=1;o<=game.countSymbolInSlot;o++){var e=game.field[i][o].y;if(e<=0&&Math.abs(e)<=config.speed){t.offset=Math.abs(e),t.isLastCalc=!0;break}}return t},checkWin:function(){for(var i=!0,t=1;t<=config.slotCount;t++)for(var o=1;o<=game.countSymbolInSlot;o++)game.field[t][o].y===config.symbolHeight*(config.centerLine-1)&&game.centerSymbols.push(game.field[t][o].type);var e=game.centerSymbols[0];for(var n in game.centerSymbols){if(e!==game.centerSymbols[n]){i=!1;break}e=game.centerSymbols[n]}return i},winAnimation:function(){game.winIterator+=1;var i=game.winIterator>config.winAnimationCount;i||main.context.clearRect(0,(config.centerLine-1)*config.symbolHeight,game.width,config.symbolHeight);for(var t=1;t<=config.slotCount;t++){var o=config.symbolWidth*(t-1),e=config.symbolHeight*(config.centerLine-1),n=(game.winIterator-1)*config.symbolWidth,a=game.centerSymbols[t-1];main.context.drawImage(main.symbols[a].img,n,0,config.symbolWidth,config.symbolHeight,o,e,config.symbolWidth,config.symbolHeight)}i||window.setTimeout(function(){requestAnimationFrame(game.winAnimation)},config.winAnimationDelay)},shuffle:function(i){for(var t,o=-1,e=i.length,n=Array(e);++o<e;)t=Math.floor(Math.random()*(o+1)),n[o]=n[t],n[t]=i[o];return n}},main={symbols:{},context:null,imageLoaded:0,calcParams:function(){game.width=config.slotCount*config.symbolWidth,game.height=config.lineCount*config.symbolHeight,game.countSymbolInSlot=config.availableSymbols.length*config.typeCount,game.slotHeight=game.countSymbolInSlot*config.symbolHeight},createCanvas:function(){var i=document.createElement("canvas");i.setAttribute("width",game.width),i.setAttribute("height",game.height),i.setAttribute("id","gameField"),document.body.insertBefore(i,document.body.childNodes[0]),main.context=i.getContext("2d")},loadImages:function(){for(var i in config.availableSymbols){var t=config.availableSymbols[i];this.symbols[t]={img:new Image},this.symbols[t].img.src="img/symbol"+t+".png",this.symbols[t].onload=main.checkImageLoad()}},checkImageLoad:function(){main.imageLoaded++,main.imageLoaded===config.availableSymbols.length&&(main.createButton(),setTimeout(main.firstDraw,100))},firstDraw:function(){for(var i=1;i<=config.slotCount;i++)for(var t=1;t<=config.lineCount;t++){var o=(i-1)*config.symbolWidth,e=(t-1)*config.symbolHeight,n=config.availableSymbols[t-1];main.context.drawImage(main.symbols[n].img,0,0,config.symbolWidth,config.symbolHeight,o,e,config.symbolWidth,config.symbolHeight)}},startClick:function(){game.isPlay||(game.init(),game.isPlay=!0,requestAnimationFrame(game.draw),setTimeout(game.stop,config.stopDelay))},createButton:function(){var i=document.getElementById("wrapper"),t=document.createElement("input");t.setAttribute("type","button"),t.setAttribute("value","Start"),t.setAttribute("id","startBtn"),t.onclick=this.startClick,i.appendChild(t)}};!function(){main.calcParams(),main.createCanvas(),main.loadImages();var i=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(i){window.setTimeout(i,1e3/60)};window.requestAnimationFrame=i}();